<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MechConnect Pro | Boels</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [x-cloak] { display: none !important; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .post-content { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Login Styles */
        #loginOverlay { 
            position: fixed; 
            inset: 0; 
            background: #262626; 
            z-index: 5000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            padding: 20px; 
        }
        .login-card { text-align: center; width: 100%; max-width: 320px; }
        .login-input { 
            padding: 16px; width: 100%; border-radius: 12px; border: none; 
            margin-bottom: 20px; color: #262626; font-size: 1rem; outline: none;
        }
    </style>
</head>
<body class="bg-[#F3F4F6] font-sans antialiased text-[#262626]" x-data="app()" x-init="init()">

    <div id="loginOverlay" x-show="!user" x-cloak>
        <div class="login-card">
            <div class="mb-8">
                <i data-lucide="wrench" class="w-16 h-16 text-[#FF6600] mx-auto mb-4"></i>
                <h2 class="text-3xl font-black italic uppercase text-white">MechConnect</h2>
                <p class="text-gray-400 font-bold uppercase text-xs tracking-widest">Professional Access</p>
            </div>
            <input type="email" id="userEmail" placeholder="vorname.nachname@boels.de" class="login-input">
            <button @click="login()" class="w-full bg-[#FF6600] text-white py-4 rounded-2xl font-black uppercase italic shadow-lg active:scale-95 transition-transform">
                Einloggen
            </button>
        </div>
    </div>

    <div x-show="popup.show" x-cloak class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.stop>
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center space-y-4">
            <i :data-lucide="popup.type === 'confirm' ? 'help-circle' : 'alert-circle'" 
               :class="popup.type === 'confirm' ? 'text-blue-500' : 'text-[#FF6600]'" class="w-12 h-12 mx-auto"></i>
            <h3 class="text-xl font-black uppercase italic" x-text="popup.title"></h3>
            <p class="text-gray-600 font-medium" x-text="popup.message"></p>
            <div class="flex gap-3">
                <template x-if="popup.type === 'confirm'">
                    <button @click="popup.show = false" class="flex-1 bg-gray-100 py-4 rounded-2xl font-black uppercase italic">Abbrechen</button>
                </template>
                <button @click="popupAction()" class="flex-1 bg-[#262626] text-white py-4 rounded-2xl font-black uppercase italic" x-text="popup.confirmText"></button>
            </div>
        </div>
    </div>

    <div x-show="lightbox.open" x-cloak class="fixed inset-0 z-[250] bg-black/95 flex items-center justify-center p-4" @click.stop>
        <button @click.stop="lightbox.open = false" class="absolute top-6 right-6 text-white bg-white/10 p-3 rounded-full hover:bg-white/20">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <button x-show="lightbox.images.length > 1" @click.stop="prevImage()" class="absolute left-4 text-white p-2"><i data-lucide="chevron-left" class="w-10 h-10"></i></button>
        <img :src="lightbox.images[lightbox.index]" class="max-w-full max-h-[85vh] object-contain rounded-lg" @click.stop>
        <button x-show="lightbox.images.length > 1" @click.stop="nextImage()" class="absolute right-4 text-white p-2"><i data-lucide="chevron-right" class="w-10 h-10"></i></button>
    </div>

    <template x-if="user && !isLoading">
        <div class="min-h-screen flex flex-col md:flex-row safe-bottom">
            
            <aside class="hidden md:flex flex-col w-72 bg-[#262626] text-white h-screen sticky top-0">
                <div class="p-8"><h1 class="text-2xl font-black italic uppercase"><i data-lucide="wrench" class="inline text-[#FF6600] mr-2"></i>MechConnect</h1></div>
                <nav class="flex-1 px-4 space-y-2">
                    <template x-for="tab in [{id:'dashboard', icon:'layout-dashboard', label:'Dashboard'}, {id:'soforthilfe', icon:'wrench', label:'Soforthilfe'}, {id:'tipps', icon:'lightbulb', label:'Tipps'}, {id:'wiki', icon:'book-open', label:'Wiki'}]">
                        <button @click="activeTab = tab.id; searchQuery = ''" :class="activeTab === tab.id ? 'bg-[#FF6600] text-white' : 'text-gray-400 hover:bg-white/10'" class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-bold uppercase italic transition-all">
                            <i :data-lucide="tab.icon" class="w-5 h-5"></i> <span x-text="tab.label"></span>
                        </button>
                    </template>
                </nav>
            </aside>

            <main class="flex-1 flex flex-col pb-24 md:pb-0 overflow-x-hidden">
                <header class="md:hidden bg-[#FF6600] px-6 py-4 flex items-center justify-between shadow-md sticky top-0 z-40">
                    <div class="flex items-center gap-3">
                        <i data-lucide="wrench" class="w-8 h-8 text-white"></i>
                        <span class="font-black italic uppercase text-lg text-white">MechConnect</span>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-white text-[#FF6600] flex items-center justify-center font-black shadow-sm" x-text="getInitials(user.name)"></div>
                </header>

                <div class="p-4 md:p-10 max-w-4xl mx-auto w-full space-y-8">
                    <div x-show="activeTab === 'dashboard'" class="space-y-6 text-center">
                        <div class="space-y-1">
                            <h2 class="text-3xl font-black text-gray-900 leading-tight">Moin, <span x-text="user.name.split(' ')[0]"></span>!</h2>
                            <p class="text-gray-500 font-medium italic" x-text="welcomeMsg"></p>
                        </div>
                        <div class="relative max-w-xl mx-auto">
                            <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            <input type="text" x-model="searchQuery" placeholder="Suche in allem..." class="w-full bg-white pl-14 pr-4 py-5 rounded-3xl shadow-sm border-none outline-none focus:ring-2 focus:ring-[#FF6600] text-lg text-left">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <template x-if="activeTab === 'dashboard'">
                            <h3 class="text-xl font-black italic uppercase text-[#262626] flex items-center justify-center gap-2">
                                <i :data-lucide="searchQuery ? 'search' : 'clock'" class="w-5 h-5 text-[#FF6600]"></i> 
                                <span x-text="searchQuery ? 'Ergebnisse' : 'Neueste Beiträge'"></span>
                            </h3>
                        </template>

                        <div x-show="activeTab !== 'dashboard'" class="flex items-center justify-between">
                            <h2 class="text-3xl font-black italic uppercase text-[#262626]" x-text="activeTab"></h2>
                            <button @click="openNewPostModal()" class="bg-[#FF6600] text-white p-3 rounded-2xl shadow-lg active:scale-90 transition-transform"><i data-lucide="plus" class="w-6 h-6"></i></button>
                        </div>

                        <template x-for="post in getFilteredPosts()" :key="post.id">
                            <div @click="openPostDetail(post)" class="bg-white rounded-3xl shadow-sm border border-gray-100 p-5 cursor-pointer hover:shadow-md transition-all active:scale-[0.99]">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex gap-3">
                                        <div class="w-10 h-10 rounded-2xl bg-[#262626] flex items-center justify-center text-white shadow-md">
                                            <i :data-lucide="getIconForType(post.type)" class="w-5 h-5"></i>
                                        </div>
                                        <div class="text-left">
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <span class="text-sm font-black uppercase text-[#FF6600]" x-text="post.subgroup"></span>
                                                <span class="text-[10px] font-bold text-gray-400 uppercase" x-text="'| ' + post.manufacturer + (post.model ? ' | ' + post.model : '')"></span>
                                            </div>
                                            <h3 class="font-black text-gray-900 leading-tight" x-text="post.title"></h3>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
                                </div>
                                <p class="text-gray-500 text-sm post-content text-left" x-text="post.description"></p>
                                <div class="mt-4 flex items-center justify-between pt-3 border-t">
                                    <span class="text-[10px] font-bold text-gray-400" x-html="post.author + '&nbsp;&nbsp;•&nbsp;&nbsp;' + formatDateTime(post.timestamp)"></span>
                                    <div class="flex items-center gap-2 text-[#FF6600] font-bold text-xs">
                                        <i data-lucide="message-square" class="w-4 h-4"></i> <span x-text="post.comments.length"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </main>

            <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-[#262626] border-t border-white/10 flex justify-around items-center px-2 py-4 z-40 safe-bottom">
                <template x-for="nav in [{id:'dashboard', icon:'home'}, {id:'soforthilfe', icon:'wrench'}, {id:'tipps', icon:'lightbulb'}, {id:'wiki', icon:'book-open'}]">
                    <button @click="activeTab = nav.id; searchQuery = ''" 
                            :class="activeTab === nav.id ? 'text-[#FF6600] scale-110' : 'text-gray-400'" 
                            class="p-2 transition-all active:scale-90">
                        <i :data-lucide="nav.icon" class="w-6 h-6"></i>
                    </button>
                </template>
            </nav>
        </div>
    </template>

    <div x-show="selectedPost" x-cloak class="fixed inset-0 z-[60] flex items-end md:items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-white w-full h-[95vh] md:h-auto md:max-h-[90vh] md:max-w-2xl rounded-t-[40px] md:rounded-[40px] flex flex-col overflow-hidden" @click.away="selectedPost = null">
            <div class="p-6 border-b flex justify-between items-center shrink-0">
                <span class="bg-[#F3F4F6] text-[10px] font-black uppercase px-3 py-1 rounded-full text-gray-500" x-text="selectedPost?.type"></span>
                <div class="flex gap-2">
                    <button x-show="selectedPost?.author === user?.name" @click.stop="triggerDeletePost(selectedPost.id)" class="p-2 bg-red-50 text-red-500 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    <button @click="selectedPost = null" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-xs font-black uppercase tracking-wider">
                        <span class="text-[#FF6600] text-lg" x-text="selectedPost?.subgroup"></span>
                        <span class="text-gray-400" x-text="'| ' + selectedPost?.manufacturer"></span>
                        <span class="text-gray-400" x-show="selectedPost?.model" x-text="'| ' + selectedPost?.model"></span>
                    </div>
                    <h2 class="text-2xl font-black leading-tight" x-text="selectedPost?.title"></h2>
                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase italic">
                        <span x-html="selectedPost?.author + '&nbsp;&nbsp;•&nbsp;&nbsp;' + (selectedPost ? formatDateTime(selectedPost.timestamp) : '')"></span>
                    </div>
                </div>
                <p class="text-gray-700 leading-relaxed whitespace-pre-line border-t pt-4 text-left" x-text="selectedPost?.description"></p>
                <div class="flex flex-wrap gap-2" x-show="selectedPost?.images?.length > 0">
                    <template x-for="(img, idx) in selectedPost?.images">
                        <img :src="img" @click.stop="openLightbox(selectedPost.images, idx)" class="w-24 h-24 object-cover rounded-xl shadow-sm border border-gray-100 cursor-zoom-in">
                    </template>
                </div>
                
                <div class="space-y-4 pt-6 border-t">
                    <h4 class="font-black italic uppercase text-sm text-left">Kommentare</h4>
                    <template x-for="c in selectedPost?.comments">
                        <div class="bg-gray-50 p-4 rounded-2xl space-y-3">
                            <div class="flex justify-between items-start">
                                <span class="text-[9px] font-bold text-gray-400 uppercase" x-html="'<span class=\'text-[#FF6600] font-black\'>' + c.author + '</span>&nbsp;&nbsp;•&nbsp;&nbsp;' + formatDateTime(c.timestamp)"></span>
                                <button x-show="c.author === user?.name" @click.stop="triggerDeleteComment(c.timestamp)" class="text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            <p class="text-sm text-left" x-text="c.text"></p>
                            <div class="flex flex-wrap gap-2" x-show="c.images?.length > 0">
                                <template x-for="(img, idx) in c.images">
                                    <img :src="img" @click.stop="openLightbox(c.images, idx)" class="w-20 h-20 object-cover rounded-lg shadow-sm cursor-zoom-in">
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="p-6 bg-white border-t border-gray-100 space-y-4">
                <div class="flex flex-wrap gap-2 justify-center" x-show="commentImages.length > 0">
                    <template x-for="(img, idx) in commentImages">
                        <div class="relative w-16 h-16">
                            <img :src="img" class="w-full h-full object-cover rounded-xl border">
                            <button @click="commentImages.splice(idx, 1)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                    </template>
                </div>
                <textarea x-model="commentText" placeholder="Schreibe eine Antwort..." class="w-full bg-gray-50 rounded-2xl p-4 text-sm outline-none focus:ring-1 focus:ring-[#FF6600] min-h-[80px]"></textarea>
                <div class="flex gap-3">
                    <label x-show="commentImages.length < 5" class="w-14 h-14 bg-gray-100 flex items-center justify-center rounded-2xl text-gray-500 cursor-pointer">
                        <i data-lucide="camera" x-show="!isCompressing"></i>
                        <input type="file" multiple accept="image/*" class="hidden" @change="handleCommentUpload">
                    </label>
                    <button @click="addComment()" class="flex-1 bg-[#262626] text-white py-4 rounded-2xl font-bold uppercase italic shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i> Senden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isNewPostModalOpen" x-cloak class="fixed inset-0 z-[60] flex items-end md:items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-white w-full h-[95vh] md:max-w-xl rounded-t-[40px] md:rounded-[40px] flex flex-col overflow-hidden">
            <div class="bg-[#262626] p-6 text-white flex justify-between items-center">
                <h3 class="text-xl font-black italic uppercase">Beitrag erstellen</h3>
                <button @click="isNewPostModalOpen = false" class="p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-5 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Subgruppe *</label>
                    <input x-model="newPost.subgroup" placeholder="Mindestens 5 Zeichen..." class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none font-bold text-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Hersteller *</label>
                    <select x-model="newPost.manufacturer" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none font-bold text-sm">
                        <template x-for="m in manufacturers"><option :value="m" x-text="m"></option></template>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Modell (Optional)</label>
                    <input x-model="newPost.model" placeholder="z.B. JCB 19C-1" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none font-bold text-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Titel *</label>
                    <input x-model="newPost.title" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none font-bold text-sm italic">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Beschreibung *</label>
                    <textarea x-model="newPost.description" rows="4" class="w-full bg-gray-50 rounded-xl px-4 py-3 outline-none text-sm"></textarea>
                </div>
                <div class="space-y-3 text-center">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Fotos (Max. 5)</label>
                    <div class="flex flex-wrap justify-center gap-3">
                        <template x-for="(img, idx) in newPost.images">
                            <div class="relative w-20 h-20">
                                <img :src="img" class="w-full h-full object-cover rounded-xl border">
                                <button @click="newPost.images.splice(idx, 1)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        </template>
                        <label x-show="newPost.images.length < 5" class="w-20 h-20 flex flex-col items-center justify-center border-2 border-dashed rounded-xl bg-gray-50 text-gray-400 cursor-pointer">
                            <i data-lucide="camera"></i>
                            <input type="file" multiple accept="image/*" class="hidden" @change="handleFileUpload">
                        </label>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t"><button @click="submitPost" class="w-full bg-[#FF6600] text-white py-4 rounded-2xl font-black uppercase italic shadow-lg">Veröffentlichen</button></div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoading: true, user: null, activeTab: 'dashboard', searchQuery: '', isNewPostModalOpen: false, isCompressing: false, selectedPost: null, 
                commentText: '', commentImages: [], posts: [], 
                welcomeMsg: '',
                sprueche: [
                    "Schön, dass du wieder am Start bist!",
                    "Dein Know-how ist gefragt – schau mal, was es Neues gibt!",
                    "Schön, dass du wieder da bist – dein Wissen ist gefragt."
                ],
                manufacturers: ["JCB", "Caterpillar", "Kubota", "Manitou", "Bomag", "Wacker Neuson", "Sonstige"],
                newPost: { type: '', subgroup: '', manufacturer: 'JCB', model: '', title: '', description: '', images: [] },
                lightbox: { open: false, images: [], index: 0 },
                popup: { show: false, title: '', message: '', type: 'alert', confirmText: 'Verstanden', action: null },

                init() {
                    const savedUser = localStorage.getItem('mc-user');
                    const savedPosts = localStorage.getItem('mc-posts');
                    
                    if (savedUser) {
                        this.user = JSON.parse(savedUser);
                    }
                    
                    this.posts = savedPosts ? JSON.parse(savedPosts) : [];
                    this.welcomeMsg = this.sprueche[Math.floor(Math.random() * this.sprueche.length)];
                    
                    // Initialer Ladevorgang
                    this.isLoading = false;
                    this.refreshIcons();
                },

                login() {
                    const mail = document.getElementById('userEmail').value.trim();
                    if(mail.toLowerCase().endsWith('@boels.de')) {
                        // Namen generieren wie in index3.html
                        const name = mail.split('@')[0].split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                        this.user = { name: name, email: mail };
                        localStorage.setItem('mc-user', JSON.stringify(this.user));
                        
                        // Icons nach dem Login laden
                        this.$nextTick(() => { this.refreshIcons(); });
                    } else { 
                        this.showPopup("Zugriff verweigert", "Bitte nutze deine offizielle @boels.de E-Mail Adresse."); 
                    }
                },

                getInitials(name) {
                    if (!name) return '??';
                    const parts = name.split(' ');
                    if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
                    return name.substring(0, 2).toUpperCase();
                },

                showPopup(title, message, type = 'alert', confirmText = 'Verstanden', action = null) {
                    this.popup = { show: true, title, message, type, confirmText, action };
                    this.refreshIcons();
                },

                popupAction() {
                    if (this.popup.action) this.popup.action();
                    this.popup.show = false;
                },

                refreshIcons() { this.$nextTick(() => { lucide.createIcons(); }); },

                formatDateTime(ts) {
                    const d = new Date(ts);
                    return `${d.toLocaleDateString('de-DE')}&nbsp;&nbsp;•&nbsp;&nbsp;${d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`;
                },

                getIconForType(type) {
                    const icons = { 'soforthilfe': 'wrench', 'tipps': 'lightbulb', 'wiki': 'book-open' };
                    return icons[type] || 'message-square';
                },

                getFilteredPosts() {
                    let res = this.posts;
                    if (this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        res = res.filter(p => 
                            p.title.toLowerCase().includes(q) || p.subgroup.toLowerCase().includes(q) || 
                            p.description.toLowerCase().includes(q) || p.manufacturer.toLowerCase().includes(q) || 
                            p.model?.toLowerCase().includes(q) || p.author.toLowerCase().includes(q)
                        );
                    } else if (this.activeTab !== 'dashboard') {
                        res = res.filter(p => p.type === this.activeTab);
                    } else { res = res.slice(0, 15); }
                    return res;
                },

                openLightbox(images, index) { this.lightbox.images = images; this.lightbox.index = index; this.lightbox.open = true; this.refreshIcons(); },
                prevImage() { this.lightbox.index = (this.lightbox.index - 1 + this.lightbox.images.length) % this.lightbox.images.length; },
                nextImage() { this.lightbox.index = (this.lightbox.index + 1) % this.lightbox.images.length; },

                openPostDetail(p) { this.selectedPost = p; this.commentText = ''; this.commentImages = []; this.refreshIcons(); },

                triggerDeletePost(id) {
                    this.showPopup("Beitrag löschen?", "Möchtest du diesen Beitrag wirklich unwiderruflich entfernen?", "confirm", "Löschen", () => {
                        this.posts = this.posts.filter(p => p.id !== id);
                        this.selectedPost = null;
                        this.save();
                    });
                },

                triggerDeleteComment(ts) {
                    this.showPopup("Kommentar löschen?", "Möchtest du deine Antwort entfernen?", "confirm", "Löschen", () => {
                        this.selectedPost.comments = this.selectedPost.comments.filter(c => c.timestamp !== ts);
                        this.save();
                    });
                },

                openNewPostModal() { 
                    if (this.activeTab === 'dashboard') return;
                    this.newPost = { type: this.activeTab, subgroup: '', manufacturer: 'JCB', model: '', title: '', description: '', images: [] };
                    this.isNewPostModalOpen = true; 
                    this.refreshIcons();
                },

                addComment() {
                    if (!this.commentText.trim() && this.commentImages.length === 0) return this.showPopup("Hinweis", "Dein Kommentar ist leer.");
                    this.selectedPost.comments.push({ author: this.user.name, text: this.commentText, images: [...this.commentImages], timestamp: Date.now() });
                    this.commentText = ''; this.commentImages = []; this.save();
                },

                async handleCommentUpload(e) { 
                    const fs = Array.from(e.target.files);
                    const remaining = 5 - this.commentImages.length;
                    if (fs.length > remaining) this.showPopup("Hinweis", "Maximal 5 Fotos pro Kommentar erlaubt.");
                    const toUpload = fs.slice(0, remaining);
                    for (let f of toUpload) this.commentImages.push(await this.compress(f));
                    this.refreshIcons(); 
                },

                async handleFileUpload(e) { 
                    const fs = Array.from(e.target.files);
                    const remaining = 5 - this.newPost.images.length;
                    if (fs.length > remaining) this.showPopup("Hinweis", "Maximal 5 Fotos erlaubt.");
                    const toUpload = fs.slice(0, remaining);
                    for (let f of toUpload) this.newPost.images.push(await this.compress(f));
                },

                compress(f) {
                    return new Promise(r => {
                        const rd = new FileReader();
                        rd.onload = (e) => {
                            const i = new Image();
                            i.onload = () => {
                                const c = document.createElement('canvas');
                                const m = 1000; let w = i.width, h = i.height;
                                if (w > m) { h *= m/w; w = m; }
                                c.width = w; c.height = h;
                                c.getContext('2d').drawImage(i, 0, 0, w, h);
                                r(c.toDataURL('image/jpeg', 0.7));
                            };
                            i.src = e.target.result;
                        };
                        rd.readAsDataURL(f);
                    });
                },

                submitPost() {
                    if (this.newPost.subgroup.trim().length === 0) return this.showPopup("Hinweis", "Subgruppe fehlt.");
                    if (this.newPost.subgroup.trim().length < 5) return this.showPopup("Hinweis", "Subgruppe muss mindestens 5 Zeichen enthalten.");
                    if (!this.newPost.manufacturer) return this.showPopup("Hinweis", "Hersteller fehlt.");
                    if (this.newPost.title.trim().length === 0) return this.showPopup("Hinweis", "Titel fehlt.");
                    if (this.newPost.description.trim().length === 0) return this.showPopup("Hinweis", "Beschreibung fehlt.");
                    this.posts.unshift({ ...this.newPost, id: Date.now(), author: this.user.name, timestamp: Date.now(), comments: [] });
                    this.save(); this.isNewPostModalOpen = false; this.refreshIcons();
                },

                save() { localStorage.setItem('mc-posts', JSON.stringify(this.posts)); }
            }
        }
    </script>
</body>
</html>
