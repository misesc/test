<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MechConnect">
    
    <title>MechConnect | Professional</title>
    <style>
        :root { 
            --boels-orange: #FF6600; 
            --boels-black: #1a1a1a; 
            --boels-grey: #f4f4f4; 
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom); 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background: var(--boels-grey); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        header { 
            background: var(--boels-orange); 
            color: white; 
            padding: calc(var(--safe-area-inset-top) + 0.8rem) 1rem 0.8rem 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            flex-shrink: 0; 
            gap: 15px; 
        }
        
        .logo-container { display: flex; align-items: center; gap: 10px; cursor: pointer; flex-shrink: 0; }
        .logo-text { line-height: 1; display: flex; flex-direction: column; }
        .logo-text .main { font-weight: 900; font-size: 1.2rem; letter-spacing: 0.5px; }
        .logo-text .sub { font-weight: 200; font-size: 0.85rem; letter-spacing: 1px; opacity: 0.9; }

        .header-controls { flex-grow: 1; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .search-bar-header { width: 100%; max-width: 300px; padding: 8px 15px; border-radius: 20px; border: none; font-size: 0.9rem; outline: none; }

        #headerBtnNeu { 
            display: none; background: white; color: var(--boels-orange); border: none; 
            padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap;
        }

        .main-wrapper { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        
        nav { width: 250px; background: var(--boels-black); color: white; padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
        nav h4 { color: #666; text-transform: uppercase; font-size: 0.8rem; margin: 20px 0 10px 0; }
        nav ul { padding: 0; list-style: none; margin: 0; }
        nav li { padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        nav li:hover { background: #333; }
        nav li.active { background: var(--boels-orange); color: white; font-weight: bold; }

        main { flex-grow: 1; padding: 20px; overflow-y: auto; padding-bottom: calc(100px + var(--safe-area-inset-bottom)); position: relative; }

        .dash-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; max-width: 800px; }
        .dash-tile { 
            background: white; padding: 25px; border-radius: 12px; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 8px solid var(--boels-orange); 
            display: flex; align-items: center; gap: 20px; transition: background 0.2s;
        }
        .dash-tile:hover { background: #fdfdfd; }
        .dash-tile i { font-size: 2.2rem; min-width: 40px; text-align: center; font-style: normal; }
        .dash-tile h3 { font-size: 1.3rem; margin: 0; color: var(--boels-black); }

        .post-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid var(--boels-orange); }
        .search-cat-header { background: var(--boels-black); color: white; padding: 8px 15px; border-radius: 6px; margin: 25px 0 10px 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        .tag-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .sub-tag { background: var(--boels-black); color: white; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .manu-tag { background: #eee; color: #333; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; border: 1px solid #ddd; }

        #detailPage { 
            display: none; 
            position: absolute; 
            inset: 0; 
            background: var(--boels-grey); 
            z-index: 500; 
            padding: 15px; 
            padding-top: calc(var(--safe-area-inset-top) + 10px);
            overflow-y: auto; 
        }
        .detail-content-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 1000px; margin: 0 auto 100px auto; }
        
        .back-btn { 
            background: var(--boels-black); 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem;
        }

        .comment-section-divider { margin: 30px -25px 10px -25px; background: #f0f0f0; padding: 12px 25px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; font-weight: bold; color: #333; text-align: center; }
        
        .comment { padding: 15px 0; border-bottom: 1px solid #ddd; }
        .comment p { margin: 8px 0; line-height: 1.4; } 
        
        .attachment-grid { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
        .thumb-box { width: 90px; height: 90px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; cursor: pointer; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }

        .reply-box { margin-top: 20px; }

        .bottom-nav { 
            display: none; 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: var(--boels-black); 
            grid-template-columns: repeat(5, 1fr); 
            z-index: 1000; 
            border-top: 2px solid var(--boels-orange); 
            padding-bottom: var(--safe-area-inset-bottom); 
        }
        .bottom-nav button { background: none; border: none; color: white; padding: 15px 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .bottom-nav button.active { color: var(--boels-orange); }
        
        #bnav-neu { color: var(--boels-orange) !important; font-size: 2.2rem !important; visibility: hidden; }

        @media (max-width: 768px) { 
            nav { display: none; } 
            .bottom-nav { display: grid; } 
            .search-bar-header { max-width: 150px; font-size: 0.8rem; }
            #headerBtnNeu { display: none !important; }
        }

        #galleryOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; justify-content: center; align-items: center; }
        .gallery-img { max-width: 90%; max-height: 85%; object-fit: contain; }
        .close-gallery { position: absolute; top: 20px; right: 20px; color: white; font-size: 3rem; cursor: pointer; font-weight: bold; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: none; color: white; border: none; font-size: 4rem; padding: 20px; cursor: pointer; }
        .arrow-left { left: 10px; } .arrow-right { right: 10px; }

        #loginOverlay { position: fixed; inset: 0; background: var(--boels-black); z-index: 5000; display: flex; justify-content: center; align-items: center; color: white; padding: 20px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { 
            background: white; 
            width: 100%;
            max-width: 500px; 
            padding: 25px; 
            border-radius: 16px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-content h3 { text-align: center; margin-top: 0; margin-bottom: 20px; color: var(--boels-black); font-size: 1.4rem; }
        
        .modal-content input, 
        .modal-content select, 
        .modal-content textarea,
        #replyText { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 1.1rem;
            background-color: #fff;
            color: #333;
            -webkit-appearance: none;
            appearance: none;
            resize: none; /* Verhindert manuelles Vergr√∂√üern */
        }

        #replyText {
            min-height: 120px;
        }

        .modal-content select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

        .btn-orange { 
            background: var(--boels-orange); 
            color: white; 
            border: none; 
            padding: 16px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1.1rem;
            width: 100%;
            transition: transform 0.1s;
        }
        .btn-orange:active { transform: scale(0.98); }

        .btn-upload { 
            cursor: pointer; 
            background: #f8f8f8; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.95rem; 
            border: 1px dashed #bbb; 
            width: 100%; 
            text-align: center; 
            display: inline-block; 
            color: #555;
            margin-bottom: 5px;
        }
        
        .btn-cancel {
            width: 100%; 
            background: white; 
            border: 1px solid #ccc; 
            margin-top: 12px; 
            padding: 12px;
            border-radius: 8px;
            cursor: pointer; 
            color: #666;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .content-section { display: none; }
        .content-section.active { display: block; }
        #searchResults { margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div style="text-align: center; width: 100%;">
            <h2 style="color: var(--boels-orange);">MECHCONNECT</h2>
            <input type="email" id="userEmail" placeholder="vorname.nachname@boels.de" style="padding:12px; width:100%; max-width:300px; border-radius:5px; border:none;">
            <br><br><button class="btn-orange" style="max-width:300px;" onclick="login()">Einloggen</button>
        </div>
    </div>

    <header>
        <div class="logo-container" onclick="showSection('dash')">
            <svg width="35" height="35" viewBox="0 0 100 100">
                <path d="M50 5 L89 27.5 L89 72.5 L50 95 L11 72.5 L11 27.5 Z" fill="none" stroke="white" stroke-width="8" stroke-linejoin="round"/>
                <path d="M30 65 V35 L50 55 L70 35 V65" fill="none" stroke="white" stroke-width="9" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="logo-text"><span class="main">MECH</span><span class="sub">CONNECT</span></div>
        </div>
        <div class="header-controls">
            <input type="text" class="search-bar-header" id="globalSearch" placeholder="Suchen..." onkeyup="handleSearch()">
            <button id="headerBtnNeu" style="width: auto;" onclick="openNewPostModal()">+ NEU</button>
        </div>
    </header>

    <div class="main-wrapper">
        <nav>
            <h4>Hauptmen√º</h4>
            <ul>
                <li id="menu-dash" class="active" onclick="showSection('dash')">üè† Home</li>
                <li id="menu-feed" onclick="showSection('feed')">üö® Soforthilfe</li>
                <li id="menu-tips" onclick="showSection('tips')">üí° Tipps & Tricks</li>
                <li id="menu-wiki" onclick="showSection('wiki')">üìö Wiki</li>
            </ul>
        </nav>

        <main>
            <div id="section-dash" class="content-section active">
                <h1 id="welcomeText">Willkommen!</h1>
                <div id="dashDefault" class="dash-grid">
                    <div class="dash-tile" onclick="showSection('feed')"><i>üö®</i><h3>Soforthilfe</h3></div>
                    <div class="dash-tile" onclick="showSection('tips')"><i>üí°</i><h3>Tipps & Tricks</h3></div>
                    <div class="dash-tile" onclick="showSection('wiki')"><i>üìö</i><h3>Wiki</h3></div>
                </div>
                <div id="searchResults">
                    <h2>Ergebnisse:</h2>
                    <div id="searchList"></div>
                </div>
            </div>

            <div id="section-feed" class="content-section"><h1>üö® Soforthilfe</h1><div id="feedList"></div></div>
            <div id="section-tips" class="content-section"><h1>üí° Tipps & Tricks</h1><div id="tipsList"></div></div>
            <div id="section-wiki" class="content-section"><h1>üìö Wiki</h1><div id="wikiList"></div></div>

            <div id="detailPage">
                <button class="back-btn" onclick="closeDetail()">Zur√ºck</button>
                <div class="detail-content-card">
                    <div id="detailBody"></div>
                    <div class="comment-section-divider">ANTWORTEN & L√ñSUNGEN</div>
                    <div id="commentList"></div>
                    <div class="reply-box">
                        <textarea id="replyText" placeholder="Schreibe etwas dazu..." style="margin-bottom:10px;"></textarea>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                            <label class="btn-upload">üì∑ Bild / Datei hinzuf√ºgen <input type="file" id="replyFiles" multiple accept="image/*" hidden onchange="updateFileLabel('replyFiles', 'replyFileStatus')"></label>
                            <span id="replyFileStatus" style="font-size:0.8rem; color:#666;"></span>
                            <button class="btn-orange" onclick="submitReply()">Antworten</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="bottom-nav">
        <button id="bnav-dash" onclick="showSection('dash')" class="active">üè†</button>
        <button id="bnav-feed" onclick="showSection('feed')">üö®</button>
        <button id="bnav-neu" onclick="openNewPostModal()">‚ûï</button>
        <button id="bnav-tips" onclick="showSection('tips')">üí°</button>
        <button id="bnav-wiki" onclick="showSection('wiki')">üìö</button>
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Neuer Beitrag</h3>
            <input type="text" id="postSub" placeholder="Subgruppe (z.B. 12052) *">
            <select id="postManu">
                <option value="">Hersteller w√§hlen *</option>
                <option>Atlas Copco</option><option>Haulotte</option><option>JLG</option><option>Kubota</option><option>Wacker Neuson</option>
            </select>
            <input type="text" id="postType" placeholder="Typ (Optional)">
            <input type="text" id="postTitle" placeholder="Titel / Fehlercode *">
            <textarea id="postDesc" rows="5" placeholder="Problembeschreibung... *"></textarea>
            
            <div style="margin-bottom: 15px;">
                <label class="btn-upload">üì∑ Bild / Datei hinzuf√ºgen <input type="file" id="postFiles" multiple accept="image/*" hidden onchange="updateFileLabel('postFiles', 'postFileStatus')"></label>
                <div id="postFileStatus" style="font-size:0.8rem; color:#666; text-align:center;"></div>
            </div>

            <button onclick="savePost()" class="btn-orange">Beitrag ver√∂ffentlichen</button>
            <button onclick="document.getElementById('postModal').style.display='none'" class="btn-cancel">Abbrechen</button>
        </div>
    </div>

    <div id="galleryOverlay">
        <span class="close-gallery" onclick="closeGallery()">&times;</span>
        <button class="nav-arrow arrow-left" onclick="changeGalleryImage(-1)">&#10094;</button>
        <img id="galleryImg" class="gallery-img" src="">
        <button class="nav-arrow arrow-right" onclick="changeGalleryImage(1)">&#10095;</button>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content" style="text-align: center; border-top: 5px solid var(--boels-orange); width: 400px; max-width: 90%;">
            <h3 style="color: var(--boels-black); margin-top: 0;">Hinweis</h3>
            <p id="alertMessage" style="margin: 20px 0; line-height: 1.5; color: #333;"></p>
            <button onclick="document.getElementById('alertModal').style.display='none'" class="btn-orange">OK</button>
        </div>
    </div>

    <script>
        let posts = JSON.parse(localStorage.getItem('mConnect_DB')) || { feed: [], tips: [], wiki: [] };
        let currentUser = localStorage.getItem('mConnect_User') || "";
        
        let activeCategory = "feed";
        let currentSection = "dash";
        let currentGalleryImages = [], currentGalleryIndex = 0;
        let activePost = null; 
        const categoryNames = { feed: "Soforthilfe", tips: "Tipps & Tricks", wiki: "Wiki" };

        window.onload = () => {
            if(currentUser) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `Hallo, ${currentUser}!`;
                showSection('dash');
                ['feed', 'tips', 'wiki'].forEach(cat => renderList(cat));
            }
        };

        function showAlert(msg) {
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('alertModal').style.display = 'flex';
        }

        function login() {
            const mail = document.getElementById('userEmail').value.trim();
            if(mail.toLowerCase().endsWith('@boels.de')) {
                currentUser = mail.split('@')[0].split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                localStorage.setItem('mConnect_User', currentUser);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `Hallo, ${currentUser}!`;
                showSection('dash');
            } else { showAlert("Bitte @boels.de Mail nutzen."); }
        }

        function showSection(id) {
            currentSection = id;
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav li, .bottom-nav button').forEach(el => el.classList.remove('active'));
            document.getElementById('detailPage').style.display = 'none';
            if(document.getElementById('section-' + id)) document.getElementById('section-' + id).classList.add('active');
            
            const mobilePlusBtn = document.getElementById('bnav-neu');
            const desktopPlusBtn = document.getElementById('headerBtnNeu');
            
            if(id === 'dash') {
                mobilePlusBtn.style.visibility = 'hidden';
                desktopPlusBtn.style.display = 'none';
            } else {
                mobilePlusBtn.style.visibility = 'visible';
                desktopPlusBtn.style.display = 'block';
                activeCategory = id;
                renderList(id);
            }
            
            const mItem = document.getElementById('menu-' + id); if(mItem) mItem.classList.add('active');
            const bItem = document.getElementById('bnav-' + id); if(bItem) bItem.classList.add('active');
            handleSearch();
        }

        function handleSearch() {
            const val = document.getElementById('globalSearch').value.toLowerCase().trim();
            const dashDefault = document.getElementById('dashDefault');
            const searchResults = document.getElementById('searchResults');
            const searchList = document.getElementById('searchList');

            const filterFn = (p) => (
                p.title.toLowerCase().includes(val) || 
                p.sub.toLowerCase().includes(val) || 
                p.manu.toLowerCase().includes(val) || 
                (p.type && p.type.toLowerCase().includes(val)) || 
                p.desc.toLowerCase().includes(val)
            );

            if(currentSection === 'dash') {
                if(val === "") { dashDefault.style.display = 'flex'; searchResults.style.display = 'none'; }
                else {
                    dashDefault.style.display = 'none'; searchResults.style.display = 'block'; searchList.innerHTML = "";
                    ['feed', 'tips', 'wiki'].forEach(cat => {
                        const results = posts[cat].filter(filterFn);
                        if(results.length > 0) {
                            const header = document.createElement('div');
                            header.className = 'search-cat-header'; header.innerText = categoryNames[cat];
                            searchList.appendChild(header);
                            results.forEach(p => searchList.appendChild(createPostCard(p, cat)));
                        }
                    });
                }
            } else { 
                const container = document.getElementById(activeCategory + 'List');
                if(!container) return;
                container.innerHTML = '';
                posts[activeCategory].filter(filterFn).forEach(p => container.appendChild(createPostCard(p, activeCategory)));
            }
        }

        function createPostCard(p, cat) {
            const card = document.createElement('div');
            card.className = 'post-card';
            card.onclick = () => openDetail(p, cat);
            card.innerHTML = `<div class="tag-row"><span class="sub-tag">${p.sub}</span><span class="manu-tag">${p.manu}</span>${p.type ? `<span class="manu-tag">${p.type}</span>` : ''}</div>
                <strong>${p.title}</strong><br><small>üë§ ${p.user} | üìÖ ${p.date} | üëÄ ${p.views}</small>`;
            return card;
        }

        function openNewPostModal() {
            document.getElementById('modalTitle').innerText = "Neuer Beitrag f√ºr " + categoryNames[activeCategory];
            document.getElementById('postFileStatus').innerText = "";
            document.getElementById('postModal').style.display = 'flex';
        }

        async function savePost() {
            const sub = document.getElementById('postSub').value.trim();
            const manu = document.getElementById('postManu').value;
            const title = document.getElementById('postTitle').value.trim();
            const desc = document.getElementById('postDesc').value.trim();
            const type = document.getElementById('postType').value.trim();

            if (!sub || !manu || !title || !desc) {
                return showAlert("Bitte alle Pflichtfelder (*) ausf√ºllen!");
            }
            if (sub.length < 5) {
                return showAlert("Die Subgruppe muss mindestens 5 Zeichen enthalten!");
            }

            const urls = await Promise.all(Array.from(document.getElementById('postFiles').files).map(f => readFile(f)));
            const p = { 
                id: Date.now(), sub, manu, title, desc, urls, type, user: currentUser, views: 0, 
                date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                comments: []
            };
            
            posts[activeCategory].unshift(p);
            localStorage.setItem('mConnect_DB', JSON.stringify(posts));
            
            renderList(activeCategory);
            document.getElementById('postModal').style.display = 'none';
            
            document.getElementById('postSub').value = ""; document.getElementById('postTitle').value = ""; 
            document.getElementById('postDesc').value = ""; document.getElementById('postFiles').value = "";
            document.getElementById('postManu').value = ""; document.getElementById('postType').value = "";
        }

        function renderList(cat) {
            const container = document.getElementById(cat + 'List');
            if(!container) return;
            container.innerHTML = '';
            posts[cat].forEach(p => container.appendChild(createPostCard(p, cat)));
        }

        function openDetail(p, cat) {
            activePost = p;
            p.views++;
            localStorage.setItem('mConnect_DB', JSON.stringify(posts));
            
            const body = document.getElementById('detailBody');
            body.innerHTML = `<div class="tag-row"><span class="sub-tag">${p.sub}</span><span class="manu-tag">${p.manu}</span>${p.type ? `<span class="manu-tag">${p.type}</span>` : ''}</div>
                <h1 style="margin: 10px 0;">${p.title}</h1><p style="white-space: pre-wrap; user-select: text; margin-bottom: 15px;">${p.desc}</p>
                <div class="attachment-grid">${p.urls.map((u, i) => `<div class="thumb-box" onclick='openGallery(${JSON.stringify(p.urls)}, ${i})'><img src="${u}"></div>`).join('')}</div>
                <div style="font-size:0.9rem; color:#666; border-top:1px solid #eee; padding-top:10px;"><strong>${p.user}</strong> | üìÖ ${p.date}</div>`;
            
            renderComments();
            document.getElementById('detailPage').style.display = 'block';
        }

        function renderComments() {
            const list = document.getElementById('commentList');
            list.innerHTML = '';
            (activePost.comments || []).forEach(c => {
                const div = document.createElement('div');
                div.className = 'comment';
                div.innerHTML = `<div style="font-size:0.8rem; color:#666;"><strong>${c.user}</strong> | üìÖ ${c.date}</div><p style="user-select: text;">${c.text}</p>
                    <div class="attachment-grid">${(c.urls || []).map((u, i) => `<div class="thumb-box" onclick='openGallery(${JSON.stringify(c.urls)}, ${i})'><img src="${u}"></div>`).join('')}</div>`;
                list.appendChild(div);
            });
        }

        function closeDetail() { document.getElementById('detailPage').style.display = 'none'; }

        async function submitReply() {
            const txt = document.getElementById('replyText').value.trim();
            const urls = await Promise.all(Array.from(document.getElementById('replyFiles').files).map(f => readFile(f)));
            if(!txt && urls.length === 0) return;
            
            const timeString = new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            if(!activePost.comments) activePost.comments = [];
            activePost.comments.push({
                user: currentUser, text: txt, urls: urls, date: timeString
            });
            
            localStorage.setItem('mConnect_DB', JSON.stringify(posts));
            renderComments();
            
            document.getElementById('replyText').value = ""; document.getElementById('replyFiles').value = ""; document.getElementById('replyFileStatus').innerText = "";
        }

        function openGallery(urls, i) {
            currentGalleryImages = urls; currentGalleryIndex = i;
            document.getElementById('galleryImg').src = urls[i];
            document.getElementById('galleryOverlay').style.display = 'flex';
            document.querySelectorAll('.nav-arrow').forEach(a => a.style.display = urls.length > 1 ? 'block' : 'none');
        }
        function changeGalleryImage(s) {
            currentGalleryIndex = (currentGalleryIndex + s + currentGalleryImages.length) % currentGalleryImages.length;
            document.getElementById('galleryImg').src = currentGalleryImages[currentGalleryIndex];
        }
        function closeGallery() { document.getElementById('galleryOverlay').style.display = 'none'; }
        
        function readFile(f) { 
            return new Promise(res => { 
                const reader = new FileReader(); 
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > 800) { h *= 800/w; w = 800; } 
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(f); 
            }); 
        }

        function updateFileLabel(inputId, statusId) { 
            const count = document.getElementById(inputId).files.length; 
            document.getElementById(statusId).innerText = count > 0 ? count + " Datei(en) ausgew√§hlt" : ""; 
        }
    </script>
</body>
</html>
