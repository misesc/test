<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MechConnect">
    <title>MechConnect | Professional</title>
    <style>
        :root { 
            --boels-orange: #FF6600; 
            --boels-black: #1a1a1a; 
            --boels-grey: #f4f4f4; 
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--boels-grey); display: flex; flex-direction: column; height: 100vh; overflow: hidden; overscroll-behavior: none; }
        header { background: var(--boels-orange); color: white; padding: 1.2rem 1rem 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .logo-text .main { font-weight: 900; font-size: 1.2rem; letter-spacing: 0.5px; }
        .logo-text .sub { font-weight: 200; font-size: 0.85rem; letter-spacing: 1px; opacity: 0.9; display: block; }
        .search-bar-header { width: 130px; padding: 8px 12px; border-radius: 20px; border: none; font-size: 0.85rem; outline: none; transition: width 0.3s; }
        .search-bar-header:focus { width: 180px; }
        .main-wrapper { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        nav { width: 250px; background: var(--boels-black); color: white; padding: 20px; flex-shrink: 0; }
        nav li { padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        nav li.active { background: var(--boels-orange); font-weight: bold; }
        main { flex-grow: 1; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(80px + var(--safe-area-inset-bottom)); }
        .dash-tile { background: white; padding: 20px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 6px solid var(--boels-orange); display: flex; align-items: center; gap: 15px; }
        .post-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid var(--boels-orange); }
        .bottom-nav { display: none; position: fixed; bottom: 0; width: 100%; background: var(--boels-black); grid-template-columns: repeat(5, 1fr); padding-bottom: var(--safe-area-inset-bottom); z-index: 1000; }
        .bottom-nav button { background: none; border: none; color: white; padding: 15px 0; font-size: 1.5rem; }
        .bottom-nav button.active { color: var(--boels-orange); }
        #detailPage { display: none; position: absolute; inset: 0; background: var(--boels-grey); z-index: 500; padding: 15px; overflow-y: auto; }
        .detail-content-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 100px; }
        @media (max-width: 768px) { nav { display: none; } .bottom-nav { display: grid; } }
        #loginOverlay { position: fixed; inset: 0; background: var(--boels-black); z-index: 5000; display: flex; justify-content: center; align-items: center; color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-orange { background: var(--boels-orange); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; cursor: pointer; }
        .tag-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .sub-tag { background: #333; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .manu-tag { background: #eee; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; }
        .thumb-box { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; margin-right: 8px; border: 1px solid #ddd; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        .attachment-grid { display: flex; overflow-x: auto; padding: 10px 0; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div style="text-align: center; width: 80%;">
            <h1 style="color: var(--boels-orange); font-size: 2rem;">MECHCONNECT</h1>
            <p>Techniker-Portal</p>
            <input type="email" id="userEmail" placeholder="vorname.nachname@boels.de">
            <button class="btn-orange" onclick="login()">Einloggen</button>
        </div>
    </div>

    <header>
        <div class="logo-container" onclick="showSection('dash')">
            <div class="logo-text"><span class="main">MECH</span><span class="sub">CONNECT</span></div>
        </div>
        <input type="text" class="search-bar-header" id="globalSearch" placeholder="Suchen..." onkeyup="handleSearch()">
    </header>

    <div class="main-wrapper">
        <nav>
            <h4>Men√º</h4>
            <ul>
                <li id="menu-dash" class="active" onclick="showSection('dash')">üè† Home</li>
                <li id="menu-feed" onclick="showSection('feed')">üö® Soforthilfe</li>
                <li id="menu-tips" onclick="showSection('tips')">üí° Tipps & Tricks</li>
                <li id="menu-wiki" onclick="showSection('wiki')">üìö Wiki</li>
            </ul>
        </nav>

        <main id="scrollArea">
            <div id="section-dash" class="content-section active">
                <h2 id="welcomeText">Hallo!</h2>
                <div id="dashDefault">
                    <div class="dash-tile" onclick="showSection('feed')"><i>üö®</i><h3>Soforthilfe</h3></div>
                    <div class="dash-tile" onclick="showSection('tips')"><i>üí°</i><h3>Tipps & Tricks</h3></div>
                    <div class="dash-tile" onclick="showSection('wiki')"><i>üìö</i><h3>Wiki</h3></div>
                </div>
                <div id="searchResults" style="display:none;"><h3>Ergebnisse:</h3><div id="searchList"></div></div>
            </div>

            <div id="section-feed" class="content-section"><h2>üö® Soforthilfe</h2><div id="feedList"></div></div>
            <div id="section-tips" class="content-section"><h2>üí° Tipps & Tricks</h2><div id="tipsList"></div></div>
            <div id="section-wiki" class="content-section"><h2>üìö Wiki</h2><div id="wikiList"></div></div>

            <div id="detailPage">
                <button onclick="closeDetail()" style="background:#333; color:white; border:none; padding:10px 15px; border-radius:8px; margin-bottom:15px;">‚Üê Zur√ºck</button>
                <div class="detail-content-card">
                    <div id="detailBody"></div>
                    <hr>
                    <h4>Antworten</h4>
                    <div id="commentList"></div>
                    <textarea id="replyText" placeholder="Deine L√∂sung oder Frage..."></textarea>
                    <input type="file" id="replyFiles" multiple accept="image/*" style="font-size: 0.8rem; margin-bottom: 10px;">
                    <button class="btn-orange" onclick="submitReply()">Antwort senden</button>
                </div>
            </div>
        </main>
    </div>

    <div class="bottom-nav">
        <button id="bnav-dash" onclick="showSection('dash')" class="active">üè†</button>
        <button id="bnav-feed" onclick="showSection('feed')">üö®</button>
        <button id="bnav-neu" onclick="openNewPostModal()" style="color:var(--boels-orange); font-size:2rem; visibility:hidden;">+</button>
        <button id="bnav-tips" onclick="showSection('tips')">üí°</button>
        <button id="bnav-wiki" onclick="showSection('wiki')">üìö</button>
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3>Neuer Beitrag</h3>
            <input type="text" id="postSub" placeholder="Subgruppe (mind. 5 Zeichen) *">
            <select id="postManu">
                <option value="">Hersteller w√§hlen *</option>
                <option>Atlas Copco</option><option>Haulotte</option><option>JLG</option><option>Kubota</option><option>Wacker Neuson</option>
            </select>
            <input type="text" id="postType" placeholder="Typ (Optional)">
            <input type="text" id="postTitle" placeholder="Titel / Fehlercode *">
            <textarea id="postDesc" rows="4" placeholder="Beschreibung... *"></textarea>
            <input type="file" id="postFiles" multiple accept="image/*">
            <button onclick="savePost()" class="btn-orange">Ver√∂ffentlichen</button>
            <button onclick="document.getElementById('postModal').style.display='none'" style="background:none; border:none; width:100%; margin-top:10px; color:#666;">Abbrechen</button>
        </div>
    </div>

    <script>
        let posts = JSON.parse(localStorage.getItem('mConnect_Posts')) || { feed: [], tips: [], wiki: [] };
        let currentUser = localStorage.getItem('mConnect_User') || "";
        let currentActiveCat = "feed";

        window.onload = () => {
            if(currentUser) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('welcomeText').innerText = `Hallo, ${currentUser.split(' ')[0]}!`;
                // Initial kein automatisches Rendern aller Listen, um Duplikate beim Start zu vermeiden
            }
        };

        function login() {
            const mail = document.getElementById('userEmail').value.trim();
            if(mail.toLowerCase().endsWith('@boels.de')) {
                currentUser = mail.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase());
                localStorage.setItem('mConnect_User', currentUser);
                location.reload();
            } else { alert("Bitte Boels-Mail nutzen."); }
        }

        function showSection(id) {
            // UI Reset
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav li, .bottom-nav button').forEach(el => el.classList.remove('active'));
            document.getElementById('detailPage').style.display = 'none';
            
            // Aktivieren
            document.getElementById('section-' + id).classList.add('active');
            const bNavNeu = document.getElementById('bnav-neu');
            bNavNeu.style.visibility = (id === 'dash') ? 'hidden' : 'visible';
            
            const mItem = document.getElementById('menu-' + id); if(mItem) mItem.classList.add('active');
            const bItem = document.getElementById('bnav-' + id); if(bItem) bItem.classList.add('active');
            
            if(id !== 'dash') {
                currentActiveCat = id;
                renderList(id);
            }
        }

        function renderList(cat) {
            const container = document.getElementById(cat + 'List');
            if(!container) return;
            
            // WICHTIG: Container leeren, bevor neu gezeichnet wird
            container.innerHTML = '';
            
            posts[cat].forEach(p => {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.onclick = (e) => { e.stopPropagation(); openDetail(p, cat); };
                card.innerHTML = `
                    <div class="tag-row"><span class="sub-tag">${p.sub}</span><span class="manu-tag">${p.manu}</span></div>
                    <strong>${p.title}</strong><br>
                    <small>${p.date} | üë§ ${p.user}</small>
                `;
                container.appendChild(card);
            });
        }

        async function savePost() {
            const sub = document.getElementById('postSub').value.trim();
            const manu = document.getElementById('postManu').value;
            const title = document.getElementById('postTitle').value.trim();
            const desc = document.getElementById('postDesc').value.trim();
            const type = document.getElementById('postType').value.trim();

            if(!sub || !manu || !title || !desc) return alert("Pflichtfelder fehlen!");
            if(sub.length < 5) return alert("Subgruppe zu kurz!");

            const urls = await Promise.all(Array.from(document.getElementById('postFiles').files).map(f => compressImage(f)));

            const newPost = {
                id: Date.now(), sub, manu, title, desc, type, urls, user: currentUser,
                date: new Date().toLocaleString('de-DE', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}),
                views: 0, comments: []
            };

            posts[currentActiveCat].unshift(newPost);
            localStorage.setItem('mConnect_Posts', JSON.stringify(posts));
            document.getElementById('postModal').style.display = 'none';
            
            // Formular zur√ºcksetzen
            document.getElementById('postSub').value = '';
            document.getElementById('postTitle').value = '';
            document.getElementById('postDesc').value = '';
            document.getElementById('postFiles').value = '';
            
            renderList(currentActiveCat);
        }

        let activePostRef = null;
        function openDetail(p, cat) {
            activePostRef = p;
            const body = document.getElementById('detailBody');
            body.innerHTML = `
                <div class="tag-row"><span class="sub-tag">${p.sub}</span><span class="manu-tag">${p.manu}</span></div>
                <h3>${p.title}</h3>
                <p style="white-space:pre-wrap; user-select:text;">${p.desc}</p>
                <div class="attachment-grid">${p.urls.map(u => `<div class="thumb-box"><img src="${u}"></div>`).join('')}</div>
                <small>Gepostet von ${p.user} am ${p.date}</small>
            `;
            renderComments();
            document.getElementById('detailPage').style.display = 'block';
        }

        async function submitReply() {
            const txt = document.getElementById('replyText').value.trim();
            if(!txt) return;
            const urls = await Promise.all(Array.from(document.getElementById('replyFiles').files).map(f => compressImage(f)));
            
            if(!activePostRef.comments) activePostRef.comments = [];
            
            activePostRef.comments.push({
                user: currentUser, text: txt, urls: urls,
                date: new Date().toLocaleString('de-DE', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})
            });
            
            localStorage.setItem('mConnect_Posts', JSON.stringify(posts));
            renderComments();
            document.getElementById('replyText').value = "";
            document.getElementById('replyFiles').value = "";
        }

        function renderComments() {
            const cList = document.getElementById('commentList');
            cList.innerHTML = '';
            (activePostRef.comments || []).forEach(c => {
                const div = document.createElement('div');
                div.style.padding = "10px 0; border-bottom: 1px solid #eee;";
                div.innerHTML = `<strong>${c.user}</strong> <small style="color:#999">${c.date}</small><br>
                <p style="user-select:text; margin:5px 0;">${c.text}</p>
                <div class="attachment-grid">${(c.urls || []).map(u => `<div class="thumb-box"><img src="${u}"></div>`).join('')}</div>`;
                cList.appendChild(div);
            });
        }

        function closeDetail() { document.getElementById('detailPage').style.display = 'none'; }
        function openNewPostModal() { document.getElementById('postModal').style.display = 'flex'; }

        function handleSearch() {
            const val = document.getElementById('globalSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            const list = document.getElementById('searchList');
            if(!val) { resultsDiv.style.display = 'none'; document.getElementById('dashDefault').style.display = 'block'; return; }
            
            document.getElementById('dashDefault').style.display = 'none';
            resultsDiv.style.display = 'block';
            list.innerHTML = '';
            
            ['feed', 'tips', 'wiki'].forEach(cat => {
                posts[cat].filter(p => p.title.toLowerCase().includes(val) || p.sub.includes(val) || p.manu.toLowerCase().includes(val)).forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'post-card';
                    card.onclick = () => openDetail(p, cat);
                    card.innerHTML = `<strong>[${cat.toUpperCase()}] ${p.title}</strong><br><small>${p.sub} | ${p.manu}</small>`;
                    list.appendChild(card);
                });
            });
        }

        function compressImage(file) {
            return new Promise(res => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > 800) { h *= 800/w; w = 800; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
